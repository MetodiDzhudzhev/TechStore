@model TechStore.Web.ViewModels.Order.OrderEditPageViewModel

@using Microsoft.AspNetCore.Mvc.Rendering
@using TechStore.Data.Models.Enums

@{
    ViewData["Title"] = $"Edit Order #{Model.Id}";

    var allowedStatuses =
        ViewBag.AllowedStatuses as IEnumerable<SelectListItem>
        ?? Enumerable.Empty<SelectListItem>();

    bool hasAllowedStatuses = allowedStatuses.Any(); 
    bool canEditShipping = Model.CanEditShipping;

    string statusBadgeClass = Model.CurrentStatus switch
    {
        Status.PendingPayment => "bg-warning text-dark",
        Status.Processing => "bg-info text-dark",
        Status.Shipped => "bg-primary",
        Status.Delivered => "bg-success",
        Status.Cancelled => "bg-danger",
        _ => "bg-secondary"
    };
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}



<div class="d-flex align-items-center justify-content-between mb-2">
    <div>
        <h2 class="mb-1">Edit order #@Model.Id</h2>
    </div>

    <a asp-area="ControlPanel"
       asp-controller="ControlPanelOrder"
       asp-action="Manage"
       class="btn btn-secondary d-inline-flex align-items-center gap-2">
        <i class="bi bi-arrow-left-circle"></i>
        Back to Manage
    </a>
</div>

<div class="card shadow-sm border mb-4"
     style="width:100%; background-color:#1c1c1e; border-color:#444;">
    <div class="card-body p-4 text-start">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div>
                <h5 class="card-title mb-1" style="color:#f0f0f0;">
                    Order summary
                </h5>
                <div style="color:#bdbdbd;">
                    Order #@Model.Id
                </div>
            </div>

            <div class="d-flex gap-3 flex-wrap">
                <div class="px-3 py-2 rounded"
                     style="background-color:#2a2a2e; border:1px solid #444;">
                    <div class="small" style="color:#bdbdbd;">Payment</div>
                    <div class="fw-semibold" style="color:#f0f0f0;">
                        @Model.PaymentMethod
                    </div>
                </div>

                <div class="px-3 py-2 rounded"
                     style="background-color:#2a2a2e; border:1px solid #444;">
                    <div class="small" style="color:#bdbdbd;">Status</div>
                    <div>
                        <span class="badge @statusBadgeClass">
                            @Model.CurrentStatus
                        </span>
                    </div>
                </div>

                <div class="px-3 py-2 rounded"
                     style="background-color:#2a2a2e; border:1px solid #444;">
                    <div class="small" style="color:#bdbdbd;">Order date</div>
                    <div class="fw-semibold" style="color:#f0f0f0;">
                        @Model.OrderDate
                    </div>
                </div>

                <div class="px-3 py-2 rounded"
                     style="background-color:#2a2a2e; border:1px solid #444;">
                    <div class="small" style="color:#bdbdbd;">Total</div>
                    <div class="fw-bold fs-5" style="color:#f0f0f0;">
                        @Model.TotalSum.ToString("F2") €
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card h-100 border"
             style="width:100%; background-color:#1c1c1e; border-color:#444;">
            <div class="card-body d-flex flex-column text-start">

                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="card-title mb-0" style="color:#f0f0f0;">Status</h5>

                    @if (hasAllowedStatuses)
                    {
                        <span class="badge" style="background-color:#1f7a3f;">editable</span>
                    }
                    else
                    {
                        <span class="badge" style="background-color:#b58b00; color:#111;">locked</span>
                    }
                </div>

                @if (!hasAllowedStatuses)
                {
                    <div class="mb-3 p-3 rounded"
                         style="background-color:#2a2a2e; border:1px solid #444; color:#e6e6e6;">
                        No status changes are available for orders that are
                        <strong style="color:#f0f0f0;">@Model.CurrentStatus.ToString().ToLower()</strong>.
                    </div>
                }

                <form asp-area="ControlPanel"
                      asp-controller="ControlPanelOrder"
                      asp-action="ChangeStatus"
                      method="post">
                    @Html.AntiForgeryToken()

                    <input asp-for="Status.Id" type="hidden" />

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold" style="color:#f0f0f0;">New status</label>

                        @if (hasAllowedStatuses)
                        {
                            <select asp-for="Status.NewStatus"
                                    asp-items="allowedStatuses"
                                    class="form-select"
                                    style="background-color:#111; border-color:#444; color:#f0f0f0;">
                            </select>

                            <span asp-validation-for="Status.NewStatus" class="text-danger small"></span>

                            <div class="form-text" style="color:#bdbdbd;">
                                Only valid next statuses are shown.
                            </div>
                        }
                        else
                        {
                            <input asp-for="Status.NewStatus" type="hidden" />
                        }
                    </div>

                    <button type="submit"
                            class="btn btn-primary px-4"
                            disabled="@(hasAllowedStatuses ? null : "disabled")">
                        Update status
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card h-100 border"
             style="width:100%; background-color:#1c1c1e; border-color:#444;">
            <div class="card-body d-flex flex-column text-start">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="card-title mb-0" style="color:#f0f0f0;">Shipping details</h5>

                    @if (canEditShipping)
                    {
                        <span class="badge" style="background-color:#1f7a3f;">editable</span>
                    }
                    else
                    {
                        <span class="badge" style="background-color:#b58b00; color:#111;">locked</span>
                    }
                </div>

                @if (!canEditShipping)
                {
                    <div class="mb-3 p-3 rounded"
                         style="background-color:#2a2a2e; border:1px solid #444; color:#e6e6e6;">
                        Shipping details are locked because the order is
                        <strong style="color:#f0f0f0;">@Model.CurrentStatus.ToString().ToLower()</strong>.
                    </div>
                }

                <form asp-area="ControlPanel"
                      asp-controller="ControlPanelOrder"
                      asp-action="EditShipping"
                      method="post"
                      class="mt-auto">
                    @Html.AntiForgeryToken()

                    <input asp-for="Shipping.Id" type="hidden" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="Shipping.RecipientName" class="form-label fw-semibold" style="color:#f0f0f0;"></label>
                            <input asp-for="Shipping.RecipientName"
                                   class="form-control"
                                   style="background-color:#111; border-color:#444; color:#f0f0f0;"
                                   readonly="@(canEditShipping ? null : "readonly")" />
                            <span asp-validation-for="Shipping.RecipientName" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Shipping.PhoneNumber" class="form-label fw-semibold" style="color:#f0f0f0;"></label>
                            <input asp-for="Shipping.PhoneNumber"
                                   class="form-control"
                                   style="background-color:#111; border-color:#444; color:#f0f0f0;"
                                   readonly="@(canEditShipping ? null : "readonly")" />
                            <span asp-validation-for="Shipping.PhoneNumber" class="text-danger small"></span>
                        </div>

                        <div class="col-12">
                            <label asp-for="Shipping.Email" class="form-label fw-semibold" style="color:#f0f0f0;"></label>
                            <input asp-for="Shipping.Email"
                                   class="form-control"
                                   style="background-color:#111; border-color:#444; color:#f0f0f0;"
                                   readonly="@(canEditShipping ? null : "readonly")" />
                            <span asp-validation-for="Shipping.Email" class="text-danger small"></span>
                        </div>

                        <div class="col-12">
                            <label asp-for="Shipping.ShippingAddress" class="form-label fw-semibold" style="color:#f0f0f0;"></label>
                            <textarea asp-for="Shipping.ShippingAddress"
                                      class="form-control"
                                      rows="3"
                                      style="background-color:#111; border-color:#444; color:#f0f0f0;"
                                      readonly="@(canEditShipping ? null : "readonly")"></textarea>
                            <span asp-validation-for="Shipping.ShippingAddress" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit"
                                class="btn btn-primary px-4"
                                disabled="@(canEditShipping ? null : "disabled")">
                            Update shipping details
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
