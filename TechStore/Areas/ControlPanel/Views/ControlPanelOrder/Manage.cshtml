@using TechStore.Web.ViewModels.Order
@model OrderManageListViewModel

@{
    ViewData["Title"] = "Manage Orders";
}

<div class="container-fluid text-light manage-orders">

    <div class="d-flex align-items-center justify-content-between mb-4">
        <h2 class="mb-0">Manage Orders</h2>
    </div>

    @if (!Model.Orders.Any())
    {
        <div class="alert alert-secondary mb-0">
            No orders found.
        </div>
    }
    else
    {
        <div class="d-flex flex-column gap-2">
            @foreach (var order in Model.Orders)
            {
                var collapseId = $"collapse-{order.Id}";

                <div class="border border-secondary rounded bg-dark">
                    <div class="d-flex align-items-center justify-content-between gap-3 px-3 py-2">

                        <div class="d-flex flex-wrap align-items-center gap-3 flex-grow-1">
                            <span class="fw-bold">Order #@order.Id</span>
                            <span class="text-secondary">@order.Date</span>

                            <span class="badge @GetStatusBadgeClass(order.Status)">
                                @order.Status
                            </span>

                            <span class="text-secondary">|</span>
                            <span class="text-secondary">@order.Email</span>

                            <span class="ms-auto fw-semibold">
                                Total: @order.TotalSum.ToString("F2") €
                            </span>
                        </div>

                        <div class="d-flex gap-2 flex-shrink-0">
                            <button class="btn btn-outline-light btn-sm"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#@collapseId"
                                    aria-expanded="false"
                                    aria-controls="@collapseId">
                                Details
                            </button>

                            <a class="btn btn-outline-primary btn-sm"
                               asp-area="ControlPanel"
                               asp-controller="ControlPanelOrder"
                               asp-action="Edit"
                               asp-route-id="@order.Id">
                                Edit
                            </a>
                        </div>
                    </div>

                    <div id="@collapseId" class="collapse">
                        <div class="p-3" style="background-color:#1c1c1e; border-top:1px solid #444;">

                            <div class="row mb-3">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <div class="small" style="color:#bdbdbd;">Recipient</div>
                                    <div class="mb-2" style="color:#f0f0f0;">@order.RecipientName</div>

                                    <div class="small" style="color:#bdbdbd;">Address</div>
                                    <div class="mb-2" style="color:#f0f0f0;">@order.ShippingAddress</div>

                                    <div class="small" style="color:#bdbdbd;">Phone</div>
                                    <div style="color:#f0f0f0;">@order.PhoneNumber</div>
                                </div>

                                <div class="col-md-6">
                                    <div class="small" style="color:#bdbdbd;">Payment method</div>
                                    <div class="mb-2" style="color:#f0f0f0;">@order.PaymentMethod</div>

                                    <div class="small" style="color:#bdbdbd;">Email</div>
                                    <div style="color:#f0f0f0;">@order.Email</div>
                                </div>
                            </div>

                            <hr style="border-color:#444;" />

                            <div class="fw-semibold mb-2" style="color:#f0f0f0;">Items</div>

                            @if (!order.Products.Any())
                            {
                                <div class="text-secondary">No products for this order.</div>
                            }
                            else
                            {
                                <div class="d-flex flex-column gap-2">
                                    @foreach (var p in order.Products)
                                    {
                                        <div class="border rounded p-2"
                                             style="border-color:#444; background-color:#121212;">
                                            <div class="d-flex gap-2">
                                                <div style="width:56px;height:56px;">
                                                    <img src="@(!string.IsNullOrWhiteSpace(p.ImageUrl) ? p.ImageUrl : Url.Content("~/images/default-image.jpg"))"
                                                         alt="@p.ProductName"
                                                         class="rounded"
                                                         style="width:56px;height:56px;object-fit:cover;" />
                                                </div>

                                                <div class="flex-grow-1">
                                                    <div class="fw-semibold" style="color:#f0f0f0;">@p.ProductName</div>

                                                    @if (!string.IsNullOrWhiteSpace(p.Description))
                                                    {
                                                        <div class="small" style="color:#bdbdbd;">
                                                            @p.Description
                                                        </div>
                                                    }

                                                    <div class="d-flex gap-2 flex-wrap mt-2">
                                                        <span class="badge bg-light text-dark border">
                                                            Qty: <span class="fw-semibold">@p.Quantity</span>
                                                        </span>
                                                        <span class="badge bg-light text-dark border">
                                                            Unit price: <span class="fw-semibold">@p.Price.ToString("F2") €</span>
                                                        </span>
                                                        <span class="badge bg-light text-dark border">
                                                            Total: <span class="fw-semibold">@p.TotalSum.ToString("F2") €</span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <nav class="mt-4" aria-label="Orders pagination">
            <ul class="pagination justify-content-center">

                <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                    <a class="page-link bg-dark text-light border-secondary"
                       asp-action="Manage"
                       asp-route-page="@(Model.CurrentPage - 1)">
                        Previous
                    </a>
                </li>

                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    bool isActive = i == Model.CurrentPage;

                    <li class="page-item @(isActive ? "active" : "")">
                        <a class="page-link border-secondary @(isActive ? "bg-primary text-white" : "bg-dark text-light")"
                           asp-action="Manage"
                           asp-route-page="@i">
                            @i
                        </a>
                    </li>
                }


                <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                    <a class="page-link bg-dark text-light border-secondary"
                       asp-action="Manage"
                       asp-route-page="@(Model.CurrentPage + 1)">
                        Next
                    </a>
                </li>

            </ul>
        </nav>
    }
</div>

@functions {
    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "PendingPayment" => "bg-warning text-dark",
            "Processing" => "bg-info text-dark",
            "Shipped" => "bg-primary",
            "Delivered" => "bg-success",
            "Cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
