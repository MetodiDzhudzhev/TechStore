@using TechStore.Web.ViewModels.Review
@model ReviewManageListViewModel

@{
    ViewData["Title"] = "Manage Reviews";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}


<div class="container-fluid text-light manage-reviews">

    <div class="d-flex align-items-center justify-content-between mb-4">
        <h2 class="mb-0">Manage Reviews</h2>
    </div>

    @if (Model.Reviews == null || !Model.Reviews.Any())
    {
        <div class="alert alert-secondary mb-0">
            No reviews found.
        </div>
    }
    else
    {
        <div class="d-flex flex-column gap-2">
            @foreach (var review in Model.Reviews)
            {
                var collapseId = $"collapse-review-{review.ReviewId}";

                <div class="border border-secondary rounded bg-dark">
                    <div class="d-flex align-items-center justify-content-between gap-3 px-3 py-2">

                        <div class="d-flex flex-wrap align-items-center gap-3 flex-grow-1">
                            <span class="fw-bold">Review #@review.ReviewId</span>

                            <span class="text-secondary">@review.CreatedAt</span>

                            <span class="badge @GetRatingBadgeClass(review.Rating)">
                                Rating: <span class="fw-semibold">@review.Rating</span> / 5
                            </span>

                            <span class="text-secondary">|</span>

                            <span class="text-secondary">
                                @review.Author
                            </span>
                        </div>

                        <div class="d-flex gap-2 flex-shrink-0">
                            <button class="btn btn-outline-light btn-sm toggle-details-btn"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#@collapseId"
                                    aria-expanded="false"
                                    aria-controls="@collapseId"
                                    data-target="#@collapseId">
                                <span class="btn-text">Details</span>
                            </button>

                            <form asp-area="ControlPanel"
                                  asp-controller="ControlPanelReview"
                                  asp-action="Delete"
                                  asp-route-id="@review.ReviewId"
                                  method="post"
                                  class="d-inline">
                                @Html.AntiForgeryToken()

                                <button type="submit"
                                        class="btn btn-outline-danger btn-sm"
                                        onclick="return confirm('Are you sure you want to delete Review #@review.ReviewId?');">
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>

                    <div id="@collapseId" class="collapse">
                        <div class="p-3" style="background-color:#1c1c1e; border-top:1px solid #444;">
                            <div class="border rounded p-3"
                                 style="border-color:#444; background-color:#121212;">
                                <div class="fw-semibold mb-1" style="color:#f0f0f0;">Comment</div>

                                @if (!string.IsNullOrWhiteSpace(review.Comment))
                                {
                                    <div style="color:#cfcfcf; white-space: pre-line;">
                                        @review.Comment
                                    </div>
                                }
                                else
                                {
                                    <div class="small" style="color:#bdbdbd;">
                                        No comment provided.
                                    </div>
                                }
                            </div>

                            <div class="mt-3">
                                <div class="fw-semibold mb-2" style="color:#f0f0f0;">Product</div>

                                <a asp-area=""
                                   asp-controller="Product"
                                   asp-action="Details"
                                   asp-route-id="@review.ProductId"
                                   class="text-decoration-none">

                                    <div class="border rounded p-2"
                                         style="border-color:#444; background-color:#121212;">
                                        <div class="d-flex gap-2">
                                            <div style="width:56px;height:56px;">
                                                <img src="@(!string.IsNullOrWhiteSpace(review.ProductImage) ? review.ProductImage : Url.Content("~/images/default-image.jpg"))"
                                                     alt="@review.ProductName"
                                                     class="rounded"
                                                     style="width:56px;height:56px;object-fit:cover;" />
                                            </div>

                                            <div class="flex-grow-1">
                                                <div class="fw-semibold" style="color:#f0f0f0;">
                                                    @review.ProductName
                                                </div>
                                                <div class="small" style="color:#bdbdbd;">
                                                    Click to open product details
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </a>
                            </div>

                        </div>
                    </div>
                </div>
            }
        </div>

        @if (Model.TotalPages > 1)
        {
            <nav class="mt-4" aria-label="Reviews pagination">
                <ul class="pagination justify-content-center">

                    <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                        <a class="page-link bg-dark text-light border-secondary"
                           asp-area="ControlPanel"
                           asp-controller="ControlPanelReview"
                           asp-action="Manage"
                           asp-route-page="@(Model.CurrentPage - 1)">
                            Previous
                        </a>
                    </li>

                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        bool isActive = i == Model.CurrentPage;

                        <li class="page-item @(isActive ? "active" : "")">
                            <a class="page-link border-secondary @(isActive ? "bg-primary text-white" : "bg-dark text-light")"
                               asp-area="ControlPanel"
                               asp-controller="ControlPanelReview"
                               asp-action="Manage"
                               asp-route-page="@i">
                                @i
                            </a>
                        </li>
                    }

                    <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                        <a class="page-link bg-dark text-light border-secondary"
                           asp-area="ControlPanel"
                           asp-controller="ControlPanelReview"
                           asp-action="Manage"
                           asp-route-page="@(Model.CurrentPage + 1)">
                            Next
                        </a>
                    </li>

                </ul>
            </nav>
        }
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll('.toggle-details-btn').forEach(function (btn) {
                const targetSelector = btn.getAttribute('data-target');
                const targetEl = document.querySelector(targetSelector);
                const textSpan = btn.querySelector('.btn-text');
                if (!targetEl || !textSpan) return;

                targetEl.addEventListener('show.bs.collapse', function () {
                    textSpan.textContent = "Hide details";
                });

                targetEl.addEventListener('hide.bs.collapse', function () {
                    textSpan.textContent = "Details";
                });
            });
        });
    </script>
}

@functions {
    private string GetRatingBadgeClass(int rating)
    {
        return rating switch
        {
            5 => "bg-success text-white",
            4 => "bg-primary text-white",
            3 => "bg-warning text-dark",
            2 => "bg-warning text-dark",
            1 => "bg-danger text-white",
            _ => "bg-secondary text-white"
        };
    }
}